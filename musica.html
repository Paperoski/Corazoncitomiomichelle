<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nuestra Playlist Interactiva</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Estilos adicionales para la funcionalidad de m칰sica */
    #spotify-login, #spotify-content {
      display: none; /* Ocultos por defecto */
    }
    #search-input {
      width: 80%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background-color: var(--light-glass);
      color: var(--text);
      font-size: 16px;
      margin-bottom: 20px;
    }
    #search-results {
      max-height: 300px;
      overflow-y: auto;
      text-align: left;
    }
    .track-item {
      display: flex;
      align-items: center;
      padding: 8px;
      border-radius: 8px;
      margin-bottom: 8px;
      transition: background-color 0.2s;
    }
    .track-item:hover {
      background-color: var(--dark-glass);
    }
    .track-item img {
      width: 50px;
      height: 50px;
      border-radius: 4px;
      margin-right: 12px;
    }
    .track-info p { margin: 0; }
    .track-info .track-name { font-weight: bold; }
    .track-info .track-artist { font-size: 14px; opacity: 0.8; }
    .add-track-btn {
      margin-left: auto;
      background: var(--accent);
      border: none;
      color: white;
      font-weight: bold;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 20px;
      cursor: pointer;
    }
    #playlist-container { margin-top: 20px; }
  </style>
</head>
<body>
    <div class="bgmedia"><img src="imagenes/minecraftfondo1.gif" alt="Fondo Rom치ntico" /></div>

    <nav class="main-nav">
        <a href="index.html" class="home-link">游눘</a>
        <a href="tiempo.html">Tiempo</a>
        <a href="frases.html">Frases</a>
        <a href="musica.html" class="active">M칰sica</a>
        <a href="juego.html">Juego</a>
    </nav>

    <div class="stage">
        <div class="content-card music-container">
            <h2>Nuestra Playlist Interactiva</h2>

            <div id="spotify-login">
                <p>Para buscar y a침adir canciones, necesitamos tu permiso.</p>
                <button id="login-button" class="btn">Conectar con Spotify</button>
            </div>

            <div id="spotify-content">
                <input type="text" id="search-input" placeholder="Busca una canci칩n o artista...">
                <div id="search-results"></div>
                <hr style="border-color: rgba(255,255,255,0.1); margin: 20px 0;">
                <h3>Nuestra Playlist Actual</h3>
                <div id="playlist-container">
                </div>
            </div>
        </div>
    </div>
  
    <div class="footer">Dise침ado con todo mi amor para ti 游눘</div>

    <script>
        const clientId = '5ce96882dde14717be9edfde38603f1e';
        const playlistId = '25i6n588yL24t5frvL';
        const redirectUri = window.location.origin + window.location.pathname;
        let accessToken = null;

        document.addEventListener('DOMContentLoaded', () => {
            const hashArgs = new URLSearchParams(window.location.hash.substring(1));
            const tokenFromUrl = hashArgs.get('access_token');
            const tokenFromStorage = sessionStorage.getItem('spotifyToken');

            if (tokenFromUrl) {
                accessToken = tokenFromUrl;
                sessionStorage.setItem('spotifyToken', tokenFromUrl);
                window.location.hash = ''; 
                initializePlayer();
            } else if (tokenFromStorage) {
                accessToken = tokenFromStorage;
                initializePlayer();
            } else {
                showLogin();
            }
        });

        function initializePlayer() {
            showContent();
            refreshPlaylistDisplay();
        }

        function showLogin() {
            document.getElementById('spotify-login').style.display = 'block';
            document.getElementById('spotify-content').style.display = 'none';
        }

        function showContent() {
            document.getElementById('spotify-login').style.display = 'none';
            document.getElementById('spotify-content').style.display = 'block';
        }

        document.getElementById('login-button').addEventListener('click', () => {
            const scope = 'playlist-modify-public playlist-modify-private';
            let url = 'https://accounts.spotify.com/authorize';
            url += '?response_type=token';
            url += '&client_id=' + encodeURIComponent(clientId);
            url += '&scope=' + encodeURIComponent(scope);
            url += '&redirect_uri=' + encodeURIComponent(redirectUri);
            window.location = url;
        });

        // --- NUEVA FUNCI칍N INTELIGENTE PARA LLAMADAS A LA API ---
        async function spotifyFetch(url, options = {}) {
            const defaultHeaders = {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json'
            };

            const response = await fetch(url, {
                ...options,
                headers: { ...defaultHeaders, ...options.headers }
            });

            if (response.status === 401) { // 401 significa "No Autorizado" (token expirado)
                console.log("Token de Spotify expirado. Redirigiendo para iniciar sesi칩n.");
                sessionStorage.removeItem('spotifyToken'); // Borra el token viejo
                showLogin(); // Muestra la pantalla de login
                return null; // Detiene la ejecuci칩n
            }
            return response;
        }


        let searchTimeout;
        document.getElementById('search-input').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value;
            if (query.length > 2) {
                searchTimeout = setTimeout(() => searchTracks(query), 500);
            } else {
                document.getElementById('search-results').innerHTML = '';
            }
        });

        async function searchTracks(query) {
            const response = await spotifyFetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=10`);
            if (!response) return; // Si la respuesta es nula (porque el token expir칩), no hagas nada.
            
            const data = await response.json();
            if (data && data.tracks) {
                displayResults(data.tracks.items);
            }
        }

        function displayResults(tracks) {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';
            tracks.forEach(track => {
                if(!track.album.images.length) return;
                const trackItem = document.createElement('div');
                trackItem.className = 'track-item';
                trackItem.innerHTML = `
                    <img src="${track.album.images[track.album.images.length - 1].url}" alt="츼lbum">
                    <div class="track-info">
                        <p class="track-name">${track.name}</p>
                        <p class="track-artist">${track.artists.map(a => a.name).join(', ')}</p>
                    </div>
                    <button class="add-track-btn" data-uri="${track.uri}">+</button>
                `;
                resultsContainer.appendChild(trackItem);
            });
        }
        
        document.getElementById('search-results').addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('add-track-btn')) {
                const trackUri = e.target.dataset.uri;
                addTrackToPlaylist(trackUri);
            }
        });

        async function addTrackToPlaylist(trackUri) {
            const response = await spotifyFetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
                method: 'POST',
                body: JSON.stringify({ uris: [trackUri] })
            });
            if (!response) return;

            alert('춰Canci칩n a침adida! 仇벒잺');
            document.getElementById('search-input').value = '';
            document.getElementById('search-results').innerHTML = '';
            refreshPlaylistDisplay();
        }

        function refreshPlaylistDisplay() {
            const container = document.getElementById('playlist-container');
            container.innerHTML = ''; // Limpia antes de a침adir
            const iframe = document.createElement('iframe');
            iframe.src = `https://open.spotify.com/embed/playlist/${playlistId}`;
            iframe.allow = "encrypted-media";
            iframe.loading = "lazy";
            iframe.style="border-radius:12px; width: 100%; height: 380px; border:none;"
            container.appendChild(iframe);
        }
    </script>
</body>
</html>
